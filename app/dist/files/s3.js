const _0x19ca=['map','Configuring\x20AWS\x20credentials\x20using\x20system\x20configuration\x20or\x20environment\x20variables','protocol','relative','hostname','extensions','createDirectory','bucket','parse','existsSync','public-read','upload','endsWith','_listBuckets','headObject','./storage','length','dirs','\x20already\x20exists\x20and\x20cannot\x20be\x20created','push','__esModule','includes','add','error','data','\x20to\x20S3\x20s3://','configuration','endpoint','getFiles','dirname','join','name','slugify','privateDirs','fromConfig','File\x20upload\x20failed:\x20','info','Name','Config','client','buckets','extname','string','localeCompare','concat','keys','private','Created\x20subdirectory\x20in\x20S3\x20s3://','exports','posix','utf-8','listBuckets','_testBucket','files','find','NextContinuationToken','IsTruncated','The\x20requested\x20AWS\x20config\x20path\x20','toClientPath','Buckets','Key','text/plain','toClientPaths','__importDefault','_listAllKeys','ContinuationToken','test','\x20does\x20not\x20exist!','message','Uploaded\x20file\x20','split','aws-sdk','aws-sdk/clients/s3','path','nextToken','Contents','default'];(function(_0x25ba11,_0x19caaf){const _0x5be6a9=function(_0x1f0151){while(--_0x1f0151){_0x25ba11['push'](_0x25ba11['shift']());}};_0x5be6a9(++_0x19caaf);}(_0x19ca,0x102));const _0x5be6=function(_0x25ba11,_0x19caaf){_0x25ba11=_0x25ba11-0x0;let _0x5be6a9=_0x19ca[_0x25ba11];return _0x5be6a9;};'use strict';var __importDefault=this&&this[_0x5be6('0x24')]||function(_0x32a7c9){return _0x32a7c9&&_0x32a7c9[_0x5be6('0x46')]?_0x32a7c9:{'default':_0x32a7c9};};Object['defineProperty'](exports,_0x5be6('0x46'),{'value':!![]});const {encodeURL,mergeObject}=require('../common/utils');const aws_sdk_1=__importDefault(require(_0x5be6('0x2c')));const s3_1=__importDefault(require(_0x5be6('0x2d')));const fs_1=__importDefault(require('fs'));const minimatch_1=__importDefault(require('minimatch'));const path_1=__importDefault(require(_0x5be6('0x2e')));const storage_1=__importDefault(require(_0x5be6('0x41')));class S3FileStorage extends storage_1[_0x5be6('0x31')]{constructor(_0x51ec06,_0x47e4e4,_0x4d78a9){super(_0x51ec06);this['config']=_0x47e4e4;this[_0x5be6('0xc')]=new s3_1['default'](_0x47e4e4);this[_0x5be6('0xd')]=_0x4d78a9;}static[_0x5be6('0x7')](_0x270662,_0x3046fc){if(!_0x3046fc)return null;let _0x28f072={};let _0x57125f=null;if(_0x3046fc===!![]){logger['info'](_0x5be6('0x33'));}else if(typeof _0x3046fc===_0x5be6('0xf')){let _0x1f09d3=_0x3046fc;if(!fs_1['default'][_0x5be6('0x3b')](_0x1f09d3))_0x1f09d3=path_1[_0x5be6('0x31')][_0x5be6('0x3')](paths['config'],_0x3046fc);if(!fs_1[_0x5be6('0x31')][_0x5be6('0x3b')](_0x1f09d3)){const _0x4a6110=new Error(_0x5be6('0x1e')+_0x1f09d3+_0x5be6('0x28'));logger[_0x5be6('0x49')](_0x4a6110);return null;}const _0x31ba6b=JSON[_0x5be6('0x3a')](fs_1[_0x5be6('0x31')]['readFileSync'](_0x1f09d3,_0x5be6('0x17')));mergeObject(_0x28f072,_0x31ba6b);if(_0x31ba6b[_0x5be6('0xd')]instanceof Array)_0x57125f=_0x31ba6b[_0x5be6('0xd')];logger[_0x5be6('0x9')]('Configured\x20AWS\x20credentials\x20using\x20'+_0x1f09d3);}const _0xd2709c=new aws_sdk_1[(_0x5be6('0x31'))][(_0x5be6('0xb'))](_0x28f072);try{return new this(_0x270662,_0xd2709c,_0x57125f);}catch(_0x5783a9){logger[_0x5be6('0x49')](_0x5783a9);return null;}}async[_0x5be6('0x38')](_0x5b0db4,{bucket}={}){let _0x2c0737=_0x5b0db4;_0x2c0737=path_1[_0x5be6('0x31')]['posix']['join'](_0x2c0737[_0x5be6('0x5')](),'/');return new Promise((_0x378e34,_0x1a099c)=>{this[_0x5be6('0xc')][_0x5be6('0x40')]({'Bucket':bucket,'Key':_0x2c0737},_0x219e20=>{if(!_0x219e20)return _0x1a099c(new Error('The\x20S3\x20key\x20'+_0x2c0737+_0x5be6('0x44')));this['client'][_0x5be6('0x3d')]({'Bucket':bucket,'Key':_0x2c0737,'Body':''},_0x4528e4=>{if(_0x4528e4)return _0x1a099c(_0x4528e4);const _0x19cf55=_0x5be6('0x14')+bucket+'/'+_0x5b0db4;logger[_0x5be6('0x9')](_0x19cf55);_0x378e34(_0x5b0db4);});});});}async[_0x5be6('0x1')]({bucket='',target='.',extensions=[],wildcard=![],isAdmin=![]}={}){const _0x310694={'target':encodeURL(target),'private':![],'gridSize':null,'dirs':[],'privateDirs':[],'files':[],'extensions':extensions};if(!bucket){_0x310694[_0x5be6('0x43')]=await this[_0x5be6('0x3f')]();return _0x310694;}let _0x4a1a5b='';if(wildcard){_0x4a1a5b=path_1[_0x5be6('0x31')]['basename'](target);target=path_1[_0x5be6('0x31')][_0x5be6('0x2')](target);}const _0x595cd8=this[_0x5be6('0x4c')][bucket]||{};const _0x4fd224=Object[_0x5be6('0x12')](_0x595cd8);_0x4fd224['sort']((_0x2c9c65,_0x1a2b0d)=>{const _0x3db11c=_0x1a2b0d[_0x5be6('0x2b')]('/')['length']-_0x2c9c65[_0x5be6('0x2b')]('/')[_0x5be6('0x42')];if(_0x3db11c!==0x0)return _0x3db11c;if(_0x2c9c65==='')return 0x1;if(_0x1a2b0d==='')return-0x1;return _0x2c9c65[_0x5be6('0x10')](_0x1a2b0d);});let _0x238fda=_0x4fd224[_0x5be6('0x1b')](_0x5eef5c=>RegExp(_0x5eef5c)[_0x5be6('0x27')](target));const _0x35cc73=_0x238fda?_0x595cd8[_0x238fda]:{'private':![],'gridSize':null};_0x310694['private']=_0x35cc73['private'];if(_0x35cc73['private']&&!isAdmin)return _0x310694;const _0x2c8500=await this[_0x5be6('0x25')](bucket,target);const _0x29afd9=new Set();for(let _0x54a929 of _0x2c8500){let _0x21057d=path_1[_0x5be6('0x31')][_0x5be6('0x16')][_0x5be6('0x35')](target,_0x54a929);if(_0x21057d==='')continue;let _0x44c064=_0x21057d['split']('/');if(_0x44c064[_0x5be6('0x42')]>0x1||_0x54a929[_0x5be6('0x3e')]('/')){_0x29afd9[_0x5be6('0x48')](_0x44c064[0x0]);continue;}if(wildcard&&!minimatch_1[_0x5be6('0x31')](_0x21057d,_0x4a1a5b))continue;if(!_0x310694[_0x5be6('0x37')]['length']||_0x310694['extensions'][_0x5be6('0x47')](path_1[_0x5be6('0x31')][_0x5be6('0xe')](_0x54a929))){_0x310694[_0x5be6('0x1a')]['push'](_0x54a929);}}for(let _0x263050 of _0x29afd9){const _0x27675e=encodeURI(path_1[_0x5be6('0x31')][_0x5be6('0x16')][_0x5be6('0x3')](target,_0x263050));const _0x22c246=_0x27675e in _0x595cd8&&_0x595cd8[_0x27675e][_0x5be6('0x13')];if(_0x22c246){if(!isAdmin)continue;_0x310694[_0x5be6('0x6')][_0x5be6('0x45')](_0x27675e);}_0x310694[_0x5be6('0x43')][_0x5be6('0x45')](_0x27675e);}_0x310694[_0x5be6('0x39')]=bucket;_0x310694[_0x5be6('0x1a')]=this[_0x5be6('0x23')](_0x310694[_0x5be6('0x1a')],bucket);return _0x310694;}async[_0x5be6('0x3f')](){if(this['buckets'])return this[_0x5be6('0xd')];console['log']('Searching\x20for\x20allowed\x20buckets\x20for\x20S3\x20storage.');const _0x5ac69d=await new Promise((_0xa5847d,_0x5b5923)=>{this['client'][_0x5be6('0x18')]((_0x995114,_0x301c33)=>{if(_0x995114)return _0x5b5923(_0x995114);const _0x5860a2=_0x301c33['Buckets']?_0x301c33[_0x5be6('0x20')][_0x5be6('0x32')](_0x52c467=>_0x52c467[_0x5be6('0xa')]):[];_0xa5847d(_0x5860a2);});});const _0xb8121b=[];for(let _0x7c895 of _0x5ac69d){const _0x306d1c=await this['_testBucket'](_0x7c895);if(_0x306d1c)_0xb8121b['push'](_0x7c895);}return this[_0x5be6('0xd')]=_0xb8121b;}async[_0x5be6('0x19')](_0x5bfc0c){return new Promise(_0x378756=>{this['client']['headBucket']({'Bucket':_0x5bfc0c},(_0x2c94e1,_0x15c292)=>{if(_0x2c94e1===null)_0x378756(!![]);else _0x378756(![]);});});}async['_listAllKeys'](_0x1e81b9,_0x36e53a){const _0x2a77e6={'Bucket':_0x1e81b9,'Prefix':_0x36e53a,'MaxKeys':0x3e8};let _0xb4eead=!![];let _0x1eca68=[];const _0x424094=_0x1b6faa=>{return new Promise((_0x190069,_0x397292)=>{this[_0x5be6('0xc')]['listObjectsV2'](_0x1b6faa,(_0x4a6855,_0x351340)=>{if(_0x4a6855)_0x397292(_0x4a6855);const _0x4c611b=_0x351340[_0x5be6('0x30')]['map'](_0x52e76b=>_0x52e76b[_0x5be6('0x21')]);_0x190069({'keys':_0x4c611b,'nextToken':_0x351340[_0x5be6('0x1d')]?_0x351340[_0x5be6('0x1c')]:null});});});};while(_0xb4eead){const _0x54a8ff=await _0x424094(_0x2a77e6);_0x1eca68=_0x1eca68[_0x5be6('0x11')](_0x54a8ff['keys']);if(_0x54a8ff['nextToken'])_0x2a77e6[_0x5be6('0x26')]=_0x54a8ff[_0x5be6('0x2f')];if(_0x54a8ff[_0x5be6('0x2f')]===null)_0xb4eead=![];}return _0x1eca68;}async['upload'](_0x1807b8,{bucket,contentType,target}={}){const _0x1707de=path_1['default'][_0x5be6('0x16')][_0x5be6('0x3')](target,_0x1807b8[_0x5be6('0x4')]);return new Promise((_0x549741,_0x58eb2e)=>{this[_0x5be6('0xc')][_0x5be6('0x3d')]({'Bucket':bucket,'Key':_0x1707de,'Body':_0x1807b8[_0x5be6('0x4a')],'ContentType':contentType||_0x5be6('0x22'),'ACL':_0x5be6('0x3c')},_0x10f5ee=>{if(_0x10f5ee)return _0x58eb2e(_0x5be6('0x8')+_0x10f5ee[_0x5be6('0x29')]);const _0x27ca55=_0x5be6('0x2a')+_0x1807b8[_0x5be6('0x4')]+_0x5be6('0x4b')+bucket+'/'+_0x1707de;logger['info'](_0x27ca55);_0x549741({'status':'success','message':_0x27ca55,'path':this[_0x5be6('0x1f')](_0x1707de,bucket)});});});}['toClientPath'](_0x37f07e,_0x43bbe1){const _0x2fd72a=this[_0x5be6('0xc')][_0x5be6('0x0')][_0x5be6('0x34')];const _0x8d80a2=this[_0x5be6('0xc')][_0x5be6('0x0')][_0x5be6('0x36')];return _0x2fd72a+'//'+_0x43bbe1+'.'+_0x8d80a2+'/'+encodeURL(_0x37f07e);}}exports[_0x5be6('0x31')]=S3FileStorage;module[_0x5be6('0x15')]=S3FileStorage;