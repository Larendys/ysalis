const _0x301d=['__esModule','accessSync','config','module.json','getProperty','overwrite','\x20does\x20not\x20exist!','utf8','AUDIO_FILE_EXTENSIONS','catch','socketListeners','mkdirp','user','world.json','availableStorageNames','_loadConfig','relative','Local\x20directory\x20','includes','options','image/','files','text/plain','contents','then','path','FILES_BROWSE','copyDirectorySync','IMAGE_FILE_EXTENSIONS','dirs','awsConfig','isAbsolute','join','extractArchive','clientConfig','isPathContained','createDirectory','_onManageFiles','fromConfig','statusText','upload','mkdir','toString','_handleCreateDirectory','gridSize','readFileSync','name','You\x20are\x20attempting\x20to\x20upload\x20a\x20file\x20with\x20a\x20disallowed\x20file\x20extension.','session','readdirSync','get','buckets','bucket','body','exports','video/','push','You\x20are\x20not\x20allowed\x20to\x20load\x20template\x20files\x20outside\x20of\x20the\x20application\x20or\x20user\x20data\x20locations','error','mergeObject','stringify','round','openReadStream','root','MEDIA_MIME_TYPES','min','contentType','getFiles','You\x20are\x20only\x20allowed\x20to\x20load\x20template\x20files\x20with\x20an\x20extension\x20in\x20[','rmdir','system.json','private','HTML_FILE_EXTENSIONS','pipe','An\x20unknown\x20error\x20occurred\x20when\x20downloading\x20file\x20','storage.json','constants','slice','_extractEntry','No\x20file\x20was\x20uploaded','existsSync','_readEntry','isAdmin','manageFiles','admin','createWriteStream','endsWith','browseFiles','template.json','active','default','readEntry','configuration','end','isDirectory','message','mimetype','entries','extname','You\x20do\x20not\x20have\x20permission\x20to\x20browse\x20the\x20host\x20file\x20system!','template','dirname','The\x20requested\x20file\x20storage\x20','manifest','downloadFile','loadTemplate','_handleGetFiles','W_OK','storage','replace','rimraf','reduce','client','configurePath','_handleConfigurePath','once','data','./s3','close','processArchive','toLowerCase','./local','test','finish','lstatSync','fileName','hasPermission','endpoint','storages','__importDefault','target','startsWith'];(function(_0x6dd711,_0x301df9){const _0x76917e=function(_0x3c9ba8){while(--_0x3c9ba8){_0x6dd711['push'](_0x6dd711['shift']());}};_0x76917e(++_0x301df9);}(_0x301d,0x80));const _0x7691=function(_0x6dd711,_0x301df9){_0x6dd711=_0x6dd711-0x0;let _0x76917e=_0x301d[_0x6dd711];return _0x76917e;};'use strict';var __importDefault=this&&this[_0x7691('0x1')]||function(_0x12da4e){return _0x12da4e&&_0x12da4e['__esModule']?_0x12da4e:{'default':_0x12da4e};};Object['defineProperty'](exports,_0x7691('0x4'),{'value':!![]});const fetch=require('node-fetch');const mkdirp=require(_0x7691('0xf'));const rimraf=require(_0x7691('0x72'));const yauzl=require('yauzl');const utils=require('../common/utils');const fs_1=__importDefault(require('fs'));const path_1=__importDefault(require(_0x7691('0x1d')));const local_1=__importDefault(require(_0x7691('0x7d')));const s3_1=__importDefault(require(_0x7691('0x79')));const const_1=require('../const');const STORAGE_CONFIGURATION_FILENAME=_0x7691('0x4f');class Files{constructor(_0x4ad0bf){this[_0x7691('0x0')]={'public':new local_1[(_0x7691('0x5e'))]('public',paths['public']),'data':new local_1[(_0x7691('0x5e'))](_0x7691('0x78'),paths[_0x7691('0x78')]),'s3':s3_1[_0x7691('0x5e')][_0x7691('0x2a')]('s3',_0x4ad0bf[_0x7691('0x22')])};this[_0x7691('0x60')]=this[_0x7691('0x13')]();}[_0x7691('0x13')](){const _0x488177=path_1[_0x7691('0x5e')][_0x7691('0x24')](paths[_0x7691('0x6')],STORAGE_CONFIGURATION_FILENAME);if(!fs_1[_0x7691('0x5e')]['existsSync'](_0x488177))return{};return JSON['parse'](fs_1[_0x7691('0x5e')][_0x7691('0x31')](_0x488177,'utf8'));}get[_0x7691('0x26')](){const _0x5b422c=this[_0x7691('0x0')]['s3'];return{'storages':this[_0x7691('0x12')],'s3':_0x5b422c?{'endpoint':_0x5b422c[_0x7691('0x74')][_0x7691('0x83')],'buckets':_0x5b422c[_0x7691('0x37')]}:null};}get[_0x7691('0x12')](){const _0x57808c=[];return Object[_0x7691('0x65')](this[_0x7691('0x0')])[_0x7691('0x73')]((_0x34bca7,_0x5ec8d6)=>{if(_0x5ec8d6[0x1])_0x34bca7['push'](_0x5ec8d6[0x0]);return _0x34bca7;},_0x57808c);}static[_0x7691('0x1f')](_0x311207,_0x384e64,{onProgress=null}={}){if(!fs_1[_0x7691('0x5e')][_0x7691('0x54')](_0x384e64))fs_1['default']['mkdirSync'](_0x384e64);const _0x3f6aa8=fs_1[_0x7691('0x5e')][_0x7691('0x35')](_0x311207);for(let _0x18a211 of _0x3f6aa8){let _0x1b7811=path_1[_0x7691('0x5e')][_0x7691('0x24')](_0x311207,_0x18a211),_0xffc1ff=path_1['default']['join'](_0x384e64,_0x18a211);if(fs_1['default'][_0x7691('0x80')](_0x1b7811)[_0x7691('0x62')]())this[_0x7691('0x1f')](_0x1b7811,_0xffc1ff,{'onProgress':onProgress});else{fs_1[_0x7691('0x5e')]['copyFileSync'](_0x1b7811,_0xffc1ff);if(onProgress instanceof Function)onProgress(_0x1b7811,_0xffc1ff);}}}static async[_0x7691('0x6c')](_0x3ca86c,_0x58db0b,{onProgress=null}={}){const _0x1a4335=path_1[_0x7691('0x5e')][_0x7691('0x69')](_0x58db0b);if(!fs_1[_0x7691('0x5e')][_0x7691('0x54')](_0x1a4335))throw new Error(_0x7691('0x15')+_0x1a4335+_0x7691('0xa'));try{fs_1[_0x7691('0x5e')][_0x7691('0x5')](_0x1a4335,fs_1['default'][_0x7691('0x50')][_0x7691('0x6f')]);}catch(_0x1a933f){throw new Error('You\x20do\x20not\x20have\x20permission\x20to\x20write\x20content\x20in\x20'+_0x1a4335+':\x20'+_0x1a933f[_0x7691('0x63')]);}const _0x25a444=await fetch(_0x3ca86c,{'referrerPolicy':'no-referrer'})[_0x7691('0xd')](_0x4da8c0=>{_0x4da8c0[_0x7691('0x63')]=_0x7691('0x4e')+_0x3ca86c+':\x20'+_0x4da8c0[_0x7691('0x63')];throw _0x4da8c0;});if(!_0x25a444['ok'])throw new Error(_0x25a444[_0x7691('0x2b')]);const _0x1a3a57=_0x25a444['headers'][_0x7691('0x36')]('content-length')||0x5f5e100;let _0x2cd8b0=0x0;let _0x5a0520=0x0;_0x25a444['body']['on'](_0x7691('0x78'),_0x2e7214=>{_0x2cd8b0+=_0x2e7214['length'];let _0x4c9ee4=Math[_0x7691('0x45')](Math[_0x7691('0x41')](_0x2cd8b0*0x64/_0x1a3a57),0x63);if(_0x4c9ee4!==_0x5a0520&&onProgress){_0x5a0520=_0x4c9ee4;if(onProgress instanceof Function)onProgress(_0x5a0520);}});_0x25a444['body']['on'](_0x7691('0x61'),()=>{if(onProgress instanceof Function)onProgress(0x64);});return new Promise((_0x27d893,_0x64cfbe)=>{const _0xa719b7=fs_1['default'][_0x7691('0x59')](_0x58db0b);_0x25a444[_0x7691('0x39')][_0x7691('0x4d')](_0xa719b7);_0xa719b7['on'](_0x7691('0x7f'),()=>{_0xa719b7[_0x7691('0x7a')]();_0x27d893();});_0xa719b7['on'](_0x7691('0x3e'),_0x64cfbe);});}static async[_0x7691('0x7b')](_0x3f6543,_0x5e6927,_0x5903da=null){const _0x3fddf8=process;return new Promise((_0x48296e,_0x7ead74)=>{_0x3fddf8['noAsar']=!![];yauzl['open'](_0x3f6543,{'lazyEntries':!![]},(_0x274a83,_0x850581)=>{if(_0x274a83)_0x7ead74(_0x274a83);const _0x13f69f=_0x850581['entryCount'];let _0x462302=0x0;_0x850581['on']('entry',async _0x2f67ed=>{_0x462302++;let _0x2bd349=Math['round'](_0x462302*0x64/_0x13f69f);await _0x5e6927(_0x850581,_0x2f67ed,_0x462302,_0x13f69f,_0x7ead74);if(_0x5903da)await _0x5903da(_0x2f67ed['fileName'],_0x462302,_0x13f69f,_0x2bd349);_0x850581[_0x7691('0x5f')]();})[_0x7691('0x77')]('error',_0x97826=>_0x7ead74(_0x97826))[_0x7691('0x77')](_0x7691('0x7a'),()=>{_0x3fddf8['noAsar']=![];_0x48296e(_0x13f69f);});_0x850581[_0x7691('0x5f')]();});});}static async[_0x7691('0x25')](_0x1c09d0,_0x4292ab,{onProgress=null,removeRoot=null}={}){const _0x25bdec=async(_0x44dda2,_0xe8e80f,_0x224cf0,_0x17003e,_0x261e90)=>{let _0x459141=_0xe8e80f[_0x7691('0x81')];if(removeRoot)_0x459141=_0x459141[_0x7691('0x71')](removeRoot,'');if(_0x459141!==''&&!_0x459141[_0x7691('0x5a')]('/')){await this[_0x7691('0x52')](_0x44dda2,_0x4292ab,_0xe8e80f,_0x459141,_0x261e90);}};return this[_0x7691('0x7b')](_0x1c09d0,_0x25bdec,onProgress);}static async['summarizeArchive'](_0x4edb65,{manifestPath=null}={}){const _0x34114a={'contents':[],'manifest':null};const _0x5ab399=async(_0x42f4f6,_0x2c34da,_0x1df218,_0x518afa,_0x6defc6)=>{let _0x48a518=_0x2c34da[_0x7691('0x81')];_0x34114a[_0x7691('0x1b')][_0x7691('0x3c')](_0x48a518);if(_0x48a518===manifestPath){_0x34114a[_0x7691('0x6b')]=await this[_0x7691('0x55')](_0x42f4f6,_0x2c34da,_0x6defc6);}};await this[_0x7691('0x7b')](_0x4edb65,_0x5ab399);return _0x34114a;}static[_0x7691('0x55')](_0x57181e,_0x2eed3d,_0x1d7b0c){return new Promise(_0x33e661=>{_0x57181e[_0x7691('0x42')](_0x2eed3d,(_0x516371,_0xaca909)=>{if(_0x516371)_0x1d7b0c(_0x516371);let _0x54dcf5='';_0xaca909['on'](_0x7691('0x78'),_0x5bea5e=>{_0x54dcf5+=_0x5bea5e[_0x7691('0x2e')]();});_0xaca909['on'](_0x7691('0x61'),()=>{_0x33e661(_0x54dcf5);});});});}static['_extractEntry'](_0x1a253d,_0x1c1fea,_0x1d8afb,_0x139cdc,_0x542acb){let _0x1249cd=path_1[_0x7691('0x5e')][_0x7691('0x24')](_0x1c1fea,_0x139cdc);Files['mkdir'](path_1[_0x7691('0x5e')]['dirname'](_0x1249cd));return new Promise(_0x23958f=>{const _0x16381f=fs_1[_0x7691('0x5e')]['createWriteStream'](_0x1249cd)['on'](_0x7691('0x7f'),_0x23958f)['on'](_0x7691('0x3e'),_0x5a9800=>_0x542acb(_0x5a9800));_0x1a253d[_0x7691('0x42')](_0x1d8afb,(_0x3a1ca8,_0x70c8a0)=>{if(_0x3a1ca8)_0x542acb(_0x3a1ca8);_0x70c8a0[_0x7691('0x4d')](_0x16381f);});});}static['getStaticFiles'](_0x9912fa,_0x24d39b,{allowHTTP=![]}={}){const _0x49f138=[];return _0x9912fa['reduce']((_0x2d53ee,_0x2f21cf)=>{for(let _0x2d4237 of _0x24d39b){if(allowHTTP&&/^https?:\/\//[_0x7691('0x7e')](_0x2f21cf)){_0x2d53ee['push'](_0x2f21cf);return _0x2d53ee;}for(let _0x5b71d4 of _0x2d4237[_0x7691('0x21')]){let _0xd000d1=path_1[_0x7691('0x5e')]['join'](_0x2d4237[_0x7691('0x43')],_0x5b71d4,_0x2f21cf);if(fs_1['default'][_0x7691('0x54')](_0xd000d1)){let _0x15a084=local_1['default']['toClientPath'](_0xd000d1,_0x2d4237['root']);_0x2d53ee[_0x7691('0x3c')](_0x15a084);return _0x2d53ee;}}}return _0x2d53ee;},_0x49f138);}static[_0x7691('0x27')](_0x950810,_0x24315a){const _0x5840a7=path_1[_0x7691('0x5e')][_0x7691('0x14')](_0x24315a,_0x950810);const _0x5f0396=_0x5840a7&&(_0x5840a7[_0x7691('0x3')]('..')||path_1[_0x7691('0x5e')][_0x7691('0x23')](_0x5840a7));return!_0x5f0396;}static[_0x7691('0x2d')](_0xbf7a1d){if(fs_1[_0x7691('0x5e')][_0x7691('0x54')](_0xbf7a1d))return _0xbf7a1d;mkdirp['sync'](_0xbf7a1d);return _0xbf7a1d;}static async[_0x7691('0x49')](_0x448e8f){return new Promise((_0x4d1df1,_0x50798d)=>{try{rimraf(_0x448e8f,_0x4d1df1);}catch(_0x2c6ee4){_0x50798d(_0x2c6ee4);}});}static[_0x7691('0x6d')](_0x3fb35b){const _0x181000=_0x3fb35b[_0x7691('0x3')]('templates')?paths['root']:paths[_0x7691('0x78')];_0x3fb35b=path_1['default'][_0x7691('0x24')](_0x181000,_0x3fb35b);if(!this[_0x7691('0x27')](_0x3fb35b,_0x181000)){throw new Error(_0x7691('0x3d'));}if(!const_1[_0x7691('0x4c')]['includes'](path_1[_0x7691('0x5e')][_0x7691('0x66')](_0x3fb35b)[_0x7691('0x51')](0x1))){throw new Error(_0x7691('0x48')+const_1[_0x7691('0x4c')]+']');}try{const _0x514026=fs_1[_0x7691('0x5e')][_0x7691('0x31')](_0x3fb35b,{'encoding':_0x7691('0xb')});return{'html':_0x514026,'success':!![]};}catch(_0x134bfd){return{'html':'','success':![],'error':_0x134bfd[_0x7691('0x63')]};}}static async[_0x7691('0x2c')](_0x2cc4bd,_0x30f3ad,_0xb5b3f8={}){if(!_0x30f3ad)throw new Error(_0x7691('0x53'));if(![_0x7691('0x78'),'s3'][_0x7691('0x16')](_0x2cc4bd))throw new Error('You\x20may\x20not\x20upload\x20to\x20this\x20location');const _0x4d8851=path_1[_0x7691('0x5e')][_0x7691('0x66')](_0x30f3ad[_0x7691('0x32')])['slice'](0x1)[_0x7691('0x7c')]();let _0xa28d9a=_0x30f3ad[_0x7691('0x64')];if(!_0xa28d9a){if(const_1['VIDEO_FILE_EXTENSIONS'][_0x7691('0x16')](_0x4d8851))_0xa28d9a=_0x7691('0x3b')+_0x4d8851;else if(const_1[_0x7691('0xc')]['includes'](_0x4d8851))_0xa28d9a='audio/'+_0x4d8851;else if(const_1[_0x7691('0x20')][_0x7691('0x16')](_0x4d8851))_0xa28d9a=_0x7691('0x18')+_0x4d8851;else _0xa28d9a=_0x7691('0x1a');}_0xb5b3f8[_0x7691('0x46')]=_0xa28d9a;const _0x3ea96d=['db'];if(_0x3ea96d[_0x7691('0x16')](_0x4d8851)){throw new Error(_0x7691('0x33'));}const _0x12abea=const_1[_0x7691('0x44')][_0x7691('0x16')](_0xa28d9a);const _0x382fef=[_0x7691('0x7'),_0x7691('0x4a'),_0x7691('0x11'),_0x7691('0x5c')][_0x7691('0x16')](_0x30f3ad['name'][_0x7691('0x7c')]());_0xb5b3f8[_0x7691('0x9')]=_0x12abea&&!_0x382fef;const _0x12174a=config['files'][_0x7691('0x0')][_0x2cc4bd];return _0x12174a['upload'](_0x30f3ad,_0xb5b3f8);}static[_0x7691('0xe')](_0xb910d3,_0x4a379a){_0xb910d3['on'](_0x7691('0x57'),(_0xe0f5f7,_0x584691,_0x4a65a9)=>{this[_0x7691('0x29')](_0xb910d3,_0xe0f5f7,_0x584691,_0x4a65a9);});_0xb910d3['on'](_0x7691('0x68'),(_0x15440a,_0x33accf)=>{try{const _0x1171b6=this[_0x7691('0x6d')](_0x15440a);_0x33accf(_0x1171b6);}catch(_0x1bc52b){_0x33accf({'error':_0x1bc52b[_0x7691('0x63')]});}});}static[_0x7691('0x29')](_0x2df537,_0x53f2f5,_0x30f932,_0x1de639){const _0x23eab2=!config[_0x7691('0x17')]['adminKey']||_0x2df537[_0x7691('0x34')][_0x7691('0x58')];const _0x134592=_0x2df537[_0x7691('0x10')]&&_0x2df537[_0x7691('0x10')][_0x7691('0x82')](_0x7691('0x1e'));if(!_0x23eab2&&!_0x134592){return _0x1de639({'error':_0x7691('0x67')});}_0x30f932[_0x7691('0x56')]=!game[_0x7691('0x5d')]&&_0x23eab2||game[_0x7691('0x5d')]&&_0x2df537[_0x7691('0x10')]['hasRole']('ASSISTANT');const _0xa29735=_0x53f2f5[_0x7691('0x70')]===_0x7691('0x10')?_0x7691('0x78'):_0x53f2f5['storage'];const _0x3f398a=config[_0x7691('0x19')]['storages'][_0xa29735];if(!_0x3f398a){return _0x1de639({'error':_0x7691('0x6a')+_0x53f2f5[_0x7691('0x70')]+'\x20does\x20not\x20exist!'});}switch(_0x53f2f5['action']){case _0x7691('0x5b'):this[_0x7691('0x6e')](_0x3f398a,_0x53f2f5,_0x30f932,_0x1de639);break;case _0x7691('0x28'):this[_0x7691('0x2f')](_0x3f398a,_0x53f2f5,_0x30f932,_0x1de639);break;case _0x7691('0x75'):this[_0x7691('0x76')](_0x3f398a,_0x53f2f5,_0x30f932,_0x1de639);}}static[_0x7691('0x2f')](_0x451d2c,_0xb873d6,_0x197ec3,_0x5b030b){_0x451d2c[_0x7691('0x28')](_0xb873d6[_0x7691('0x2')],_0x197ec3)[_0x7691('0x1c')](_0x2c55f1=>{_0x5b030b(_0x2c55f1);})[_0x7691('0xd')](_0xf25f=>{_0x5b030b({'error':_0xf25f['message']});});}static[_0x7691('0x6e')](_0xa8e8fd,_0x551c0b,_0x317a95,_0x1c2b66){const _0x91eb02=utils[_0x7691('0x3f')](_0x317a95,{'target':_0x551c0b[_0x7691('0x2')]});_0xa8e8fd[_0x7691('0x47')](_0x91eb02)['then'](_0x22c5ae=>_0x1c2b66(_0x22c5ae))[_0x7691('0xd')](_0x594f17=>_0x1c2b66({'error':_0x594f17[_0x7691('0x63')]}));}static[_0x7691('0x76')](_0x4e8f5c,_0x5ddbe1,_0x9cc713,_0x1ed7b6){let _0x17bc2b=_0x4e8f5c[_0x7691('0x60')];if(_0x9cc713[_0x7691('0x38')]){_0x17bc2b=_0x17bc2b[_0x9cc713[_0x7691('0x38')]]=_0x17bc2b[_0x9cc713[_0x7691('0x38')]]||{};}const _0x2ac70a=_0x5ddbe1[_0x7691('0x2')];const _0x5e89d6=utils[_0x7691('0x8')](_0x17bc2b,_0x2ac70a)||{};utils[_0x7691('0x3f')](_0x5e89d6,{'private':_0x9cc713[_0x7691('0x4b')],'gridSize':_0x9cc713[_0x7691('0x30')]});if(!_0x5e89d6[_0x7691('0x4b')]&&!_0x5e89d6['gridSize'])delete _0x17bc2b[_0x2ac70a];else _0x17bc2b[_0x2ac70a]=_0x5e89d6;const _0x18c1f3=path_1[_0x7691('0x5e')][_0x7691('0x24')](paths[_0x7691('0x6')],STORAGE_CONFIGURATION_FILENAME);fs_1[_0x7691('0x5e')]['writeFileSync'](_0x18c1f3,JSON[_0x7691('0x40')](config['files'][_0x7691('0x60')]));_0x1ed7b6(_0x5e89d6);}}exports['default']=Files;module[_0x7691('0x3a')]=Files;