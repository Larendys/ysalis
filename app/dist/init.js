const _0x1324=['Application\x20Options:\x0a','Each\x20world\x20has\x20its\x20own\x20uniquely\x20named\x20subdirectory\x20containing\x20a\x20world.json\x20manifest\x20file.','check','debug','This\x20directory\x20contains\x20worlds\x20which\x20define\x20the\x20game\x20and\x20campaign\x20settings\x20in\x20Foundry\x20VTT.\x20','SIGINT','uncaughtException','SIGTERM','removeMapping','listen','user','\x20path\x20','SIGHUP','upnp','data','You\x20do\x20not\x20have\x20permission\x20to\x20create\x20content\x20in\x20','./packages/world','exports','duplicate','Shut-down\x20success.\x20Goodbye!','logger','logs','server','isNumeric','sslCert','port','awsConfig','utf8','config','stringify','./files/files','createMapping','This\x20directory\x20contains\x20add-on\x20modules\x20which\x20add\x20or\x20extend\x20core\x20VTT\x20functionality.\x20','dirname','isNode','modules','./express','entries','world','readFileSync','This\x20directory\x20contains\x20systems\x20which\x20define\x20game\x20frameworks\x20for\x20use\x20in\x20Foundry\x20VTT.\x20','isElectron','all','join','A\x20fatal\x20error\x20occurred\x20while\x20trying\x20to\x20start\x20the\x20Foundry\x20Virtual\x20Tabletop\x20server','repeat','env','systems','basename','serviceConfig','existsSync','.permission-test.txt','worlds','versions','admin.txt','envOptions','options','hostname','mkdir','demo','Migrating\x20administrator\x20password\x20out\x20of\x20options.json\x20into\x20separate\x20file','writeFileSync','restart','bind','./upnp','verify','exit','once','initialize','express','/server','./update','Foundry\x20Virtual\x20Tabletop\x20requires\x20Node.js\x20version\x2012.x\x20or\x20greater.','error','message','sslKey','dataPath','warn','string','./database/database','proper-lockfile','Shutting\x20down\x20Foundry\x20Virtual\x20Tabletop\x20server','./logging','./auth','Each\x20module\x20has\x20its\x20own\x20uniquely\x20named\x20subdirectory\x20containing\x20a\x20module.json\x20manifest\x20file.','\x20does\x20not\x20exist\x20or\x20is\x20not\x20accessible.','split','./common/constants','adminKey','./interface/electron','mergeObject','Foundry\x20Virtual\x20Tabletop\x20-\x20Version\x20','isSSL','address','Loading\x20data\x20from\x20user\x20directory\x20-\x20','The\x20configured\x20','setup','parse','\x20cannot\x20start\x20in\x20this\x20directory\x20which\x20is\x20already\x20locked\x20by\x20another\x20process.','serviceKey','length','boolean','noupdate','Each\x20system\x20has\x20its\x20own\x20uniquely\x20named\x20subdirectory\x20containing\x20a\x20system.json\x20manifest\x20file.','info','unlinkSync','sockets'];(function(_0x439533,_0x13241c){const _0x46f0a7=function(_0x11bad5){while(--_0x11bad5){_0x439533['push'](_0x439533['shift']());}};_0x46f0a7(++_0x13241c);}(_0x1324,0x180));const _0x46f0=function(_0x439533,_0x13241c){_0x439533=_0x439533-0x0;let _0x46f0a7=_0x1324[_0x439533];return _0x46f0a7;};const fs=require('fs');const os=require('os');const lockfile=require(_0x46f0('0x11'));const path=require('path');const {vtt}=require(_0x46f0('0x18'));const {Express}=require(_0x46f0('0x50'));const Files=require(_0x46f0('0x4a'));const {DEFAULT_OPTIONS,getPassword,getServiceProviderConfig,License}=require(_0x46f0('0x14'));const {World}=require(_0x46f0('0x3c'));const Updater=require(_0x46f0('0x8'));const UPnP=require(_0x46f0('0x1'));const createVTTLogger=require(_0x46f0('0x13'));const util=require('./common/utils');async function initialize(_0x42a344,_0xb85fdb,_0x2fb1a0){let _0xc61c3f;let _0x3f6456;try{_0xc61c3f=global['logger']=createVTTLogger(_0xb85fdb,_0x2fb1a0);_0x3f6456=global['config']=await _initializeCriticalFunctions(_0x42a344,_0xb85fdb,_0xc61c3f);}catch(_0x1ddfdc){if(_0xc61c3f){_0xc61c3f[_0x46f0('0xa')](_0x46f0('0x58'));_0xc61c3f[_0x46f0('0xa')](_0x1ddfdc);process['exit'](0x1);}}const {app,express,license,options,upnp}=_0x3f6456;global['db']=_0x3f6456['db'];global[_0x46f0('0x6')]=_0x3f6456[_0x46f0('0x6')];global[_0x46f0('0x64')]=_0x3f6456[_0x46f0('0x64')];try{await express[_0x46f0('0x35')]();}catch(_0x39e46e){_0x39e46e[_0x46f0('0xb')]='Unable\x20to\x20start\x20Express\x20server:\x20'+_0x39e46e[_0x46f0('0xb')];throw _0x39e46e;}if(options[_0x46f0('0x52')]&&!license['needsSignature']){try{const _0x49a33f=World['get'](options[_0x46f0('0x52')],{'strict':!![]});await _0x49a33f[_0x46f0('0x21')]();}catch(_0x4722a9){_0xc61c3f[_0x46f0('0xe')](_0x4722a9);options[_0x46f0('0x52')]=null;}}process['on'](_0x46f0('0x32'),_0x2b0ef3=>_0xc61c3f[_0x46f0('0xa')](_0x2b0ef3));_0x3f6456['updater']=new Updater(_0xb85fdb);handleRestart(_0xc61c3f);process[_0x46f0('0x4')](_0x46f0('0x3'),()=>handleShutdown({'exit':![],'logger':_0xc61c3f,'express':express,'upnp':upnp}));process[_0x46f0('0x4')](_0x46f0('0x31'),process[_0x46f0('0x3')][_0x46f0('0x0')](null));process[_0x46f0('0x4')](_0x46f0('0x33'),process[_0x46f0('0x3')][_0x46f0('0x0')](null));process[_0x46f0('0x4')](_0x46f0('0x38'),process[_0x46f0('0x3')][_0x46f0('0x0')](null));if(app)app[_0x46f0('0x5')](express[_0x46f0('0x1e')],_0xc61c3f);return _0x3f6456;}async function _initializeCriticalFunctions(_0x30e86d,_0x9ffeed,_0x3e99bb){const _0x48f631=[];_testPermissions(_0x9ffeed);_createUserDataStructure(_0x9ffeed);await _acquireLockFile(_0x9ffeed);const _0x3e4e08=_loadUserOptions(_0x9ffeed);const arguments=parseArgs(_0x30e86d);const _0x3bd97b=configureOptions(arguments,_0x3e4e08,_0x9ffeed);const _0x49ca52=_setAdminPassword(_0x9ffeed[_0x46f0('0x48')],arguments[_0x46f0('0x19')]);_logApplicationConfiguration(_0x3e99bb,_0x3bd97b,_0x49ca52);const _0x12c164=_getService(_0x3bd97b,arguments);const _0x3b5bf0=new License(_0x12c164);_0x3b5bf0[_0x46f0('0x2')]();const _0x52977f=new Files(_0x3bd97b);const _0x81f7=_0x3bd97b[_0x46f0('0x39')]?new UPnP({'port':_0x3bd97b[_0x46f0('0x45')],'logger':_0x3e99bb})[_0x46f0('0x4b')]():null;let _0x2fe8bb;if(_0x3bd97b[_0x46f0('0x55')]){const {ElectronWindow}=require(_0x46f0('0x1a'));_0x2fe8bb=new ElectronWindow(_0x3bd97b);}const _0x17e28b=new Express(_0x3bd97b,_0x9ffeed,_0x3e99bb);const _0x56d371=require(_0x46f0('0x10'));await Promise[_0x46f0('0x56')](_0x48f631);return{'adminKey':_0x49ca52,'app':_0x2fe8bb,'db':_0x56d371,'express':_0x17e28b,'files':_0x52977f,'license':_0x3b5bf0,'logger':_0x3e99bb,'options':_0x3bd97b,'service':_0x12c164,'sockets':_0x17e28b['io'][_0x46f0('0x2b')]['sockets'],'upnp':_0x81f7,'userOptions':_0x3e4e08,'ver':ver,'vtt':vtt};}function _testPermissions(_0x2934ec){try{const _0x300648=fs[_0x46f0('0x5e')](_0x2934ec[_0x46f0('0x36')])?_0x2934ec['user']:path[_0x46f0('0x4d')](_0x2934ec[_0x46f0('0x36')]);let _0x2991ca=path[_0x46f0('0x57')](_0x300648,_0x46f0('0x5f'));fs['writeFileSync'](_0x2991ca,'test');fs[_0x46f0('0x2a')](_0x2991ca);}catch(_0x37abcc){_0x37abcc[_0x46f0('0xb')]=_0x46f0('0x3b')+_0x2934ec['user']+':\x20'+_0x37abcc[_0x46f0('0xb')];throw _0x37abcc;}}function _createUserDataStructure(_0x19833b){const _0x58df18=[_0x46f0('0x36'),_0x46f0('0x3a'),_0x46f0('0x48'),_0x46f0('0x41')];for(let _0x418092 of _0x58df18){Files[_0x46f0('0x66')](_0x19833b[_0x418092]);}if(!fs[_0x46f0('0x5e')](_0x19833b[_0x46f0('0x64')])){const _0x1e614d=fs['existsSync'](_0x19833b[_0x46f0('0x63')])?JSON['parse'](fs[_0x46f0('0x53')](_0x19833b[_0x46f0('0x63')])):{};const _0x4189a4=util[_0x46f0('0x1b')](DEFAULT_OPTIONS,_0x1e614d);_0x4189a4[_0x46f0('0xd')]=_0x19833b[_0x46f0('0x36')];_0x4189a4[_0x46f0('0x52')]=null;fs[_0x46f0('0x69')](_0x19833b[_0x46f0('0x64')],JSON['stringify'](_0x4189a4,null,0x2));}const _0x4d14a1=[_0x46f0('0x5b'),_0x46f0('0x4f'),_0x46f0('0x60')];const _0xa98480={'systems':_0x46f0('0x54')+_0x46f0('0x28'),'modules':_0x46f0('0x4c')+_0x46f0('0x15'),'worlds':_0x46f0('0x30')+_0x46f0('0x2d')};for(let _0x9baac5 of _0x4d14a1){let _0x1306cb=path[_0x46f0('0x57')](_0x19833b['data'],_0x9baac5);if(!fs[_0x46f0('0x5e')](_0x1306cb)){Files['mkdir'](_0x1306cb);fs[_0x46f0('0x69')](path[_0x46f0('0x57')](_0x1306cb,'README.txt'),_0xa98480[_0x9baac5]);}}}async function _acquireLockFile(_0x5d4f22){const _0x3f0036=await lockfile[_0x46f0('0x2e')](_0x5d4f22['options']);if(_0x3f0036){throw new Error(vtt+_0x46f0('0x23'));}return lockfile['lock'](_0x5d4f22[_0x46f0('0x64')],{'stale':0x2710});}function _loadUserOptions(_0x3625a9){const _0x411e85=util['mergeObject'](DEFAULT_OPTIONS,JSON[_0x46f0('0x22')](fs['readFileSync'](_0x3625a9['options'],_0x46f0('0x47'))));_0x411e85[_0x46f0('0xd')]=_0x3625a9[_0x46f0('0x36')];if(!!_0x411e85[_0x46f0('0x19')])_migrateAdminKey(_0x411e85);return _0x411e85;}function _migrateAdminKey(_0x3ac362){logger[_0x46f0('0xe')](_0x46f0('0x68'));const _0x3072e0=path['join'](paths[_0x46f0('0x48')],_0x46f0('0x62'));fs['writeFileSync'](_0x3072e0,_0x3ac362['adminKey']);delete _0x3ac362[_0x46f0('0x19')];fs[_0x46f0('0x69')](paths[_0x46f0('0x64')],JSON[_0x46f0('0x49')](_0x3ac362,null,0x2));}function _logApplicationConfiguration(_0x16104a,_0xd629b1,_0x437a92){_0x16104a[_0x46f0('0x29')](_0x46f0('0x1c')+global['ver']);const _0x241bc5=process[_0x46f0('0x61')]['node'];_0x16104a[_0x46f0('0x29')]('Running\x20on\x20Node.js\x20-\x20Version\x20'+_0x241bc5);if(_0x241bc5[_0x46f0('0x17')]('.')['shift']()<0xc){throw new Error(_0x46f0('0x9'));}const _0x216146=util[_0x46f0('0x3e')](_0xd629b1);for(let _0x8208c1 of[_0x46f0('0x44'),'sslKey',_0x46f0('0x46'),'serviceConfig']){let _0xb772eb=_0xd629b1[_0x8208c1];if(_0xb772eb&&typeof _0xb772eb===_0x46f0('0xf'))_0x216146[_0x8208c1]='*'[_0x46f0('0x59')](0x6)+'/'+path[_0x46f0('0x5c')](_0xb772eb);}if(_0x437a92)_0x216146[_0x46f0('0x19')]='*'[_0x46f0('0x59')](0x10);_0x16104a[_0x46f0('0x29')](_0x46f0('0x1f')+paths['user']);_0x16104a['info'](_0x46f0('0x2c')+JSON[_0x46f0('0x49')](_0x216146,null,0x2));}function _getService(_0x444b65,arguments){let _0x5563a5=null;if(_0x444b65[_0x46f0('0x5d')]&&arguments[_0x46f0('0x24')]){_0x5563a5=getServiceProviderConfig(_0x444b65[_0x46f0('0x5d')],arguments[_0x46f0('0x24')]);}return _0x5563a5||{'id':os[_0x46f0('0x65')](),'key':null};}function parseArgs(_0x47de2c){const arguments={};const _0x3d3c13=/^--/;for(let _0x11c8c6 of _0x47de2c){if(!_0x3d3c13['test'](_0x11c8c6))continue;_0x11c8c6=_0x11c8c6['replace'](_0x3d3c13,'');const _0x2186d1=_0x11c8c6[_0x46f0('0x17')]('=');const _0x5ef13c=_0x2186d1[0x0];const _0x157963=_0x2186d1[_0x46f0('0x25')]>0x1?_0x2186d1[0x1]:!![];arguments[_0x5ef13c]=_0x157963;}return arguments;}function configureOptions(arguments,_0x65d2f2,_0xa68b88){const _0x4e0551={};for(let [_0xfbdef7,_0x372b26]of Object[_0x46f0('0x51')](_0x65d2f2)){_0x4e0551[_0xfbdef7]=_0x372b26;}_validateConfigurationPaths(_0x4e0551);_0x4e0551['isElectron']=process[_0x46f0('0x61')]['hasOwnProperty']('electron');_0x4e0551[_0x46f0('0x4e')]=!_0x4e0551[_0x46f0('0x55')];_0x4e0551[_0x46f0('0x1d')]=_0x4e0551[_0x46f0('0xc')]!==null&&_0x4e0551[_0x46f0('0x44')]!==null;_0x4e0551[_0x46f0('0x45')]=Number[_0x46f0('0x43')](arguments[_0x46f0('0x45')])?Number(arguments[_0x46f0('0x45')]):_0x4e0551[_0x46f0('0x45')];_0x4e0551[_0x46f0('0x39')]=!arguments['noupnp']&&_0x4e0551[_0x46f0('0x39')]!==![];_0x4e0551[_0x46f0('0x52')]=arguments[_0x46f0('0x52')]||_0x4e0551[_0x46f0('0x52')]||null;_0x4e0551[_0x46f0('0x2f')]=arguments[_0x46f0('0x2f')]&&fs['existsSync'](_0xa68b88['root']+_0x46f0('0x7'));_0x4e0551[_0x46f0('0x67')]=arguments[_0x46f0('0x67')]||![];_0x4e0551[_0x46f0('0x27')]=arguments[_0x46f0('0x27')]||![];return _0x4e0551;}function _validateConfigurationPaths(_0x84ba0b){const _0xcde35c=[_0x46f0('0xc'),_0x46f0('0x44'),'awsConfig','serviceConfig'];for(let _0x2bd093 of _0xcde35c){const _0x25237a=_0x84ba0b[_0x2bd093];if(typeof _0x25237a===_0x46f0('0xf')){const _0x47f306=fs[_0x46f0('0x5e')](_0x25237a)?_0x25237a:path[_0x46f0('0x57')](paths[_0x46f0('0x48')],_0x25237a);if(fs[_0x46f0('0x5e')](_0x47f306))_0x84ba0b[_0x2bd093]=_0x47f306;else{global[_0x46f0('0x40')][_0x46f0('0xa')](_0x46f0('0x20')+_0x2bd093+_0x46f0('0x37')+_0x47f306+_0x46f0('0x16'));_0x84ba0b[_0x2bd093]=null;}}else if(typeof _0x25237a===_0x46f0('0x26')){_0x84ba0b[_0x2bd093]=_0x25237a;}else{_0x84ba0b[_0x2bd093]=null;}}}function _setAdminPassword(_0x408510,_0x4f8d2e){const _0x5ddc9f=path[_0x46f0('0x57')](_0x408510,'admin.txt');let _0x395e59=fs[_0x46f0('0x5e')](_0x5ddc9f)?fs['readFileSync'](_0x5ddc9f,_0x46f0('0x47')):null;if(!_0x395e59&&_0x4f8d2e)_0x395e59=getPassword(_0x4f8d2e);return _0x395e59;}function handleRestart(_0x15d878){if(process[_0x46f0('0x5a')][_0x46f0('0x6a')]){_0x15d878[_0x46f0('0x29')]('Server\x20restarted\x20after\x20update');delete process[_0x46f0('0x5a')]['restart'];}}function handleShutdown({exit=!![],logger,upnp,express}={}){logger['info'](_0x46f0('0x12'));if(upnp)upnp[_0x46f0('0x34')]();if(express)express[_0x46f0('0x42')]['close']();logger[_0x46f0('0x29')](_0x46f0('0x3f'));if(exit)process[_0x46f0('0x3')]();}module[_0x46f0('0x3d')]=initialize;