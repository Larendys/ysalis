const _0x594e=['embeddedEntities','temporary','schema','NeDBDatastore','isGM','has','metadata','info','\x20provided\x20for\x20Database\x20operation','preSave','length','bind','User\x20','_onDelete','name','\x20does\x20not\x20exist\x20in\x20','collection','Created\x20','s\x20in\x20parent\x20','_createDocumentId','mergeObject','expandObject','canCreate','delete','defineProperty','\x20provided\x20for\x20parent\x20Document\x20','findSplice','broadcast','postDelete','_onModifyDocument','push','./datastore','parent','siblings','exports','socketListeners','canDelete','create','\x20embedded\x20document','You\x20cannot\x20save\x20a\x20','save','Invalid\x20database\x20action\x20','canUpdate','\x20lacks\x20permission\x20to\x20delete\x20all\x20','findOne','update','constructor','validate','\x20in\x20parent\x20','__esModule','Invalid\x20Document\x20type\x20','\x20without\x20providing\x20a\x20valid\x20parentId','postSave','../../common/utils','\x20documents','EmbeddedEntities','default','Deleted\x20','all','_onCreate','modifyEmbeddedDocument','_onUpdate','createNewId','Invalid\x20EmbeddedDocument\x20type\x20','_id','\x20without\x20a\x20parent\x20object\x20defined.','__importDefault','isValidId','deleteAll','You\x20cannot\x20update\x20a\x20','\x20lacks\x20permission\x20to\x20update\x20','./abstract','\x20lacks\x20permission\x20to\x20create\x20a\x20new\x20'];(function(_0x4d3bc2,_0x594ee8){const _0x460480=function(_0x13a377){while(--_0x13a377){_0x4d3bc2['push'](_0x4d3bc2['shift']());}};_0x460480(++_0x594ee8);}(_0x594e,0x1a8));const _0x4604=function(_0x4d3bc2,_0x594ee8){_0x4d3bc2=_0x4d3bc2-0x0;let _0x460480=_0x594e[_0x4d3bc2];return _0x460480;};'use strict';var __importDefault=this&&this[_0x4604('0x7')]||function(_0x192aaf){return _0x192aaf&&_0x192aaf[_0x4604('0x3f')]?_0x192aaf:{'default':_0x192aaf};};Object[_0x4604('0x26')](exports,_0x4604('0x3f'),{'value':!![]});const util=require(_0x4604('0x43'));const abstract_1=__importDefault(require(_0x4604('0xc')));const datastore_1=require(_0x4604('0x2d'));const validators_1=__importDefault(require('./validators'));const embeddedEntities=new datastore_1[(_0x4604('0x11'))](_0x4604('0x45'),{'inMemoryOnly':!![]});class EmbeddedDocument extends abstract_1[_0x4604('0x46')]{constructor(_0x17b6f1,_0x456daa){super(_0x17b6f1);Object[_0x4604('0x26')](this,_0x4604('0x2e'),{'get':()=>_0x456daa||null});}static get[_0x4604('0x10')](){return{'_id':{'type':String,'required':!![],'default':this[_0x4604('0x21')],'validate':validators_1[_0x4604('0x46')][_0x4604('0x8')]},'flags':{'type':Object,'required':![],'default':{}}};}static get[_0x4604('0x14')](){return util[_0x4604('0x22')](super[_0x4604('0x14')],{'isPrimaryDocument':![],'isEmbeddedDocument':!![]});}static[_0x4604('0x21')](){return embeddedEntities[_0x4604('0x3')]();}get[_0x4604('0x2f')](){if(!this[_0x4604('0x2e')])return[];return this[_0x4604('0x2e')][this[_0x4604('0x3c')][_0x4604('0x1e')]];}static['canCreate'](_0x65d825,_0x11ea0b,_0x8c673){if(_0x65d825[_0x4604('0x12')])return!![];const _0x1fbec7=_0x11ea0b[_0x4604('0x3c')];return _0x1fbec7['canUpdate'](_0x65d825,_0x11ea0b,{[this[_0x4604('0x1e')]]:_0x8c673});}static[_0x4604('0x38')](_0x921a0e,_0x49a683,_0x5063c9,_0xdce110){if(_0x921a0e[_0x4604('0x12')])return!![];const _0x216632=_0x49a683[_0x4604('0x3c')];return _0x216632[_0x4604('0x38')](_0x921a0e,_0x49a683,{[this[_0x4604('0x1e')]]:_0x5063c9});}static[_0x4604('0x32')](_0x4d2eb7,_0x3e71f5,_0x8f30c6){if(_0x4d2eb7['isGM'])return!![];const _0x46e9e7=_0x3e71f5[_0x4604('0x3c')];return _0x46e9e7[_0x4604('0x38')](_0x4d2eb7,_0x3e71f5,{[this['collection']]:_0x8f30c6});}static['create'](_0x154c1e,_0x1a5bb1,_0xe9481d){_0x154c1e=util[_0x4604('0x23')](_0x154c1e);delete _0x154c1e[_0x4604('0x5')];return new this(_0x154c1e,_0x1a5bb1);}async[_0x4604('0x17')](_0x1048ec){}async['postSave'](_0x4c728a){}async[_0x4604('0x2a')](_0x59939d){}async[_0x4604('0x36')](_0x49198e={}){if(!this['parent']){throw new Error(_0x4604('0x35')+this[_0x4604('0x3c')][_0x4604('0x1c')]+_0x4604('0x6'));}await this[_0x4604('0x17')](_0x49198e);this['validate']();await this[_0x4604('0x2e')]['save'](_0x49198e);await this[_0x4604('0x42')](_0x49198e);return this;}async[_0x4604('0x25')](){const _0x303cbd=this[_0x4604('0x2e')];if(!_0x303cbd){throw new Error(_0x4604('0x35')+this[_0x4604('0x3c')][_0x4604('0x1c')]+_0x4604('0x6'));}const _0x23d58d=this['siblings'][_0x4604('0x28')](_0x16dac3=>_0x16dac3[_0x4604('0x5')]===this['_id']);const _0x20ac85=_0x303cbd[_0x4604('0x3c')]['name'];if(!_0x23d58d)throw new Error(this[_0x4604('0x3c')][_0x4604('0x1c')]+'\x20'+this['_id']+_0x4604('0x1d')+_0x20ac85+'\x20'+_0x303cbd[_0x4604('0x5')]);await _0x303cbd['save']();return this[_0x4604('0x5')];}static[_0x4604('0x31')](_0x5a5e45,_0x34c6c4){_0x5a5e45['on'](_0x4604('0x1'),_0x34c6c4[_0x4604('0x19')](_0x5a5e45,'modifyEmbeddedDocument',this[_0x4604('0x2b')]));}static async[_0x4604('0x2b')](_0x544171,{action,type,parentType,parentId,data,options}){if(!parentType||!db[parentType]){throw new Error(_0x4604('0x40')+parentType+_0x4604('0x16'));}const _0x2716ca=db[parentType];if(!type||!(type in _0x2716ca[_0x4604('0x14')][_0x4604('0xe')])){throw new Error(_0x4604('0x4')+type+_0x4604('0x27')+parentType);}const _0x4a974b=_0x2716ca[_0x4604('0x14')]['embeddedEntities'][type];if(!parentId)throw new Error('You\x20cannot\x20create\x20a\x20'+this[_0x4604('0x1c')]+_0x4604('0x41'));const _0x102371=await _0x2716ca[_0x4604('0x3a')]({'_id':parentId});switch(action){case _0x4604('0x33'):return _0x4a974b[_0x4604('0x0')](_0x544171,_0x102371,data,options);case _0x4604('0x3b'):return _0x4a974b[_0x4604('0x2')](_0x544171,_0x102371,data,options);case'delete':return _0x4a974b[_0x4604('0x1b')](_0x544171,_0x102371,data,options);default:throw new Error(_0x4604('0x37')+action+'\x20requested\x20on\x20the\x20'+type+_0x4604('0x34'));}}static async[_0x4604('0x0')](_0x4733e1,_0x2ea415,_0x47ba14,_0x57e8c8){_0x47ba14=_0x47ba14 instanceof Array?_0x47ba14:[_0x47ba14];let _0x13b23d=[];const _0x5cd076=_0x2ea415[this[_0x4604('0x1e')]];for(let _0x3fbfb8 of _0x47ba14){delete _0x3fbfb8['_id'];const _0x53f8a5=this[_0x4604('0x33')](_0x3fbfb8,_0x2ea415,_0x4733e1);let _0x34c75a=await this[_0x4604('0x24')](_0x4733e1,_0x2ea415,_0x53f8a5);if(!_0x34c75a){const _0x1ed5b9=_0x4604('0x1a')+_0x4733e1[_0x4604('0x1c')]+_0x4604('0xd')+this[_0x4604('0x1c')]+_0x4604('0x3e')+_0x2ea415['constructor'][_0x4604('0x1c')]+'\x20'+_0x2ea415[_0x4604('0x5')];throw new Error(_0x1ed5b9);}await _0x53f8a5[_0x4604('0x17')](_0x57e8c8);_0x53f8a5[_0x4604('0x3d')]();_0x5cd076[_0x4604('0x2c')](_0x53f8a5);_0x13b23d['push'](_0x53f8a5);}if(!_0x57e8c8[_0x4604('0xf')]){await _0x2ea415[_0x4604('0x36')]();for(let _0x84e880 of _0x13b23d){await _0x84e880[_0x4604('0x42')](_0x57e8c8);}let _0x19c321=_0x13b23d['length']===0x1?_0x4604('0x1f')+this[_0x4604('0x1c')]:'Created\x20'+_0x13b23d[_0x4604('0x18')]+'\x20'+this[_0x4604('0x1c')]+'s';if(_0x13b23d[_0x4604('0x18')]===0x1)_0x19c321+='\x20'+_0x13b23d[0x0][_0x4604('0x5')];else if(_0x13b23d[_0x4604('0x18')]<=0x5)_0x19c321+='\x20['+_0x13b23d['map'](_0x4c090c=>_0x4c090c[_0x4604('0x5')])+']';_0x19c321+=_0x4604('0x3e')+_0x2ea415[_0x4604('0x3c')][_0x4604('0x1c')]+'\x20'+_0x2ea415[_0x4604('0x5')];logger[_0x4604('0x15')](_0x19c321);}else _0x57e8c8[_0x4604('0x29')]=![];return _0x13b23d;}static async[_0x4604('0x2')](_0x3cca06,_0x37fbcb,_0x1a3e19,_0x3e304b){_0x1a3e19=_0x1a3e19 instanceof Array?_0x1a3e19:[_0x1a3e19];const _0x178c4f=new Map();for(let _0x518a52 of _0x1a3e19 instanceof Array?_0x1a3e19:[_0x1a3e19]){if(!(_0x4604('0x5')in _0x518a52))throw new Error(_0x4604('0xa')+this[_0x4604('0x1c')]+'\x20without\x20providing\x20an\x20_id');_0x178c4f['set'](_0x518a52['_id'],_0x518a52);}const _0x33d891=_0x37fbcb[this[_0x4604('0x1e')]];const _0x5132dc=[];for(let _0x60af96 of _0x33d891){if(!_0x178c4f[_0x4604('0x13')](_0x60af96[_0x4604('0x5')]))continue;const _0x3f65ed=_0x178c4f['get'](_0x60af96[_0x4604('0x5')]);const _0x2e65d3=await this[_0x4604('0x38')](_0x3cca06,_0x37fbcb,_0x60af96,_0x3f65ed);if(!_0x2e65d3){throw new Error(_0x4604('0x1a')+_0x3cca06[_0x4604('0x1c')]+_0x4604('0xb')+this[_0x4604('0x1c')]+_0x4604('0x20')+_0x37fbcb['_id']);}_0x60af96[_0x4604('0x3b')](_0x3f65ed,_0x3e304b);await _0x60af96[_0x4604('0x17')](_0x3e304b);delete _0x60af96['_changed'];_0x60af96[_0x4604('0x3d')]();_0x5132dc[_0x4604('0x2c')](_0x3f65ed);}await _0x37fbcb[_0x4604('0x36')](_0x3e304b);return _0x5132dc;}static async['_onDelete'](_0x5e58c3,_0x1f523b,_0x126a07,_0x7f7620){_0x126a07=_0x126a07 instanceof Array?_0x126a07:[_0x126a07];const _0x413e1c=_0x1f523b[this[_0x4604('0x1e')]];const _0x17593e=[];const _0x512c9f=[];if(_0x7f7620[_0x4604('0x9')]){const _0x40cedf=await _0x1f523b[_0x4604('0x38')](_0x5e58c3);if(!_0x40cedf){throw new Error(_0x4604('0x1a')+_0x5e58c3[_0x4604('0x1c')]+_0x4604('0x39')+this['name']+_0x4604('0x44'));}}else{const _0x30ddb4=new Set(_0x126a07);for(let _0x1e00e3 of _0x413e1c){if(!_0x30ddb4[_0x4604('0x13')](_0x1e00e3['_id'])){_0x17593e[_0x4604('0x2c')](_0x1e00e3);continue;}const _0x2b2467=await this['canDelete'](_0x5e58c3,_0x1f523b,_0x1e00e3);if(!_0x2b2467){throw new Error(_0x4604('0x1a')+_0x5e58c3[_0x4604('0x1c')]+'\x20lacks\x20permission\x20to\x20delete\x20'+this[_0x4604('0x1c')]+'s\x20in\x20parent\x20'+_0x1f523b[_0x4604('0x5')]);}_0x512c9f['push'](_0x1e00e3[_0x4604('0x5')]);}}_0x1f523b[this['collection']]=_0x17593e;await _0x1f523b[_0x4604('0x36')]();let _0xafb588=_0x512c9f['length']===0x1?'Deleted\x20'+this[_0x4604('0x1c')]:_0x4604('0x47')+(_0x7f7620[_0x4604('0x9')]?_0x4604('0x48'):_0x512c9f[_0x4604('0x18')])+'\x20'+this[_0x4604('0x1c')]+'s';if(_0x512c9f[_0x4604('0x18')]===0x1)_0xafb588+='\x20'+_0x512c9f[0x0];else if(!_0x7f7620['deleteAll']&&_0x512c9f['length']<=0x5)_0xafb588+='\x20['+_0x512c9f+']';_0xafb588+='\x20from\x20parent\x20'+_0x1f523b['constructor']['name']+'\x20'+_0x1f523b[_0x4604('0x5')];logger[_0x4604('0x15')](_0xafb588);return _0x512c9f;}}exports[_0x4604('0x46')]=EmbeddedDocument;module[_0x4604('0x30')]=EmbeddedDocument;