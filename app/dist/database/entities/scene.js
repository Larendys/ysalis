const _0x3c40=['migrate','exports','globalLight','px\x20or\x20greater','actorData','lights','globalLightThreshold','The\x20grid\x20size\x20must\x20be\x20an\x20integer\x20number\x20of\x20pixels,\x20','navigation','data:image/png','cleanHTML','SQUARE','You\x20may\x20not\x20delete\x20a\x20thumbnail\x20image\x20that\x20is\x20not\x20a\x20valid\x20image\x20file\x20type','isNumeric','grid','../embedded/tile','replace','data','fogExploration','forEach','thumbs','logger','deleteThumbnail','activate','tokenVision','gridType','Invalid\x20grid\x20distance,\x20must\x20be\x20larger\x20than\x200','_changed','weather','items','info','#999999','constructor','gridDistance','posix','isObjectEmpty','between','equals','tokens','Scene\x20background\x20height\x20must\x20be\x20a\x20positive\x20integer','createThumbnail','../embedded/wall','_handleThumbnailChange','existsSync','Activating\x20scene\x20','backgroundColor','canCreate','../odm/validators','values','relative','Vertically\x20shifted\x20scene\x20position\x20must\x20be\x20an\x20integer\x20number\x20of\x20pixels','walls','path','schema','sockets','update','world','postDelete','_id','active','hasImageExtension','thumb','mime-types','shiftX','emit','Scene\x20navigation\x20order\x20must\x20be\x20an\x20integer','pullToScene','startsWith','split','_priorThumbPath','name','drawings','templates','_validateInitialPosition','scenes','sep','preloadScene','image/','hasVideoExtension','padding','shiftY','navOrder','../embedded/template','The\x20global\x20illumination\x20threshold\x20must\x20be\x20a\x20number\x20between\x200\x20and\x201,\x20or\x20null','mergeObject','deleteMany','includes','./journal','unlinkSync','isFinite','base64','isGM','metadata','join','gridColor','Scene\x20grid\x20color\x20must\x20be\x20a\x20valid\x20CSS\x20color\x20string.','Invalid\x20grid\x20type\x20specified','every','socketListeners','writeFileSync','isInteger','number','Item','find','Scene\x20padding\x20must\x20be\x20between\x200\x20and\x200.5','gridAlpha','sort','error','system','canUpdate','preSave','initial','darkness','gridUnits','map','paths','sounds','navName','keys','thumbDir','img','tiles','width','length','all','../../common/constants','The\x20provided\x20media\x20file\x20does\x20not\x20have\x20a\x20valid\x20image\x20or\x20video\x20file\x20extension.','../embedded/token','Scene\x20background\x20color\x20must\x20be\x20a\x20valid\x20CSS\x20color\x20string.','\x20Scenes\x20to\x20the\x20latest\x20system\x20data\x20model','height','../embedded/sounds','from','../embedded/light','../../files/files','notes','isColorString'];(function(_0x54badc,_0x3c40d2){const _0x2f582d=function(_0x22a681){while(--_0x22a681){_0x54badc['push'](_0x54badc['shift']());}};_0x2f582d(++_0x3c40d2);}(_0x3c40,0x1c8));const _0x2f58=function(_0x54badc,_0x3c40d2){_0x54badc=_0x54badc-0x0;let _0x2f582d=_0x3c40[_0x54badc];return _0x2f582d;};const path=require(_0x2f58('0x7'));const fs=require('fs');const util=require('../../common/utils');const Entity=require('../odm/entity');const Files=require(_0x2f58('0x59'));const Validators=require(_0x2f58('0x2'));const mime=require(_0x2f58('0x11'));const {GRID_TYPES,GRID_MIN_SIZE}=require(_0x2f58('0x50'));class Scene extends Entity{constructor(..._0x1513e3){super(..._0x1513e3);this[_0x2f58('0x18')]=this['thumb'];}static get[_0x2f58('0x8')](){const _0x410603=super['schema'];_0x410603['description']={'type':String,'required':![],'default':''};_0x410603[_0x2f58('0x64')]={'type':Boolean,'required':!![],'default':!![]};_0x410603[_0x2f58('0x24')]={'type':Number,'required':![],'validate':_0x13d60c=>Number[_0x2f58('0x37')](_0x13d60c),'validationError':_0x2f58('0x14')};_0x410603[_0x2f58('0x48')]={'type':String,'required':![]};_0x410603[_0x2f58('0xe')]={'type':Boolean,'required':!![],'default':![]};_0x410603[_0x2f58('0x42')]={'type':Object,'required':![],'default':null,'validate':this[_0x2f58('0x1c')],'validationError':'Invalid\x20initial\x20view\x20position\x20object\x20provided\x20for\x20Scene'};_0x410603[_0x2f58('0x4b')]={'type':String,'required':![],'validate':_0x1feed9=>{return Validators['hasImageExtension'](_0x1feed9)||Validators[_0x2f58('0x21')](_0x1feed9);},'validationError':_0x2f58('0x51')};_0x410603[_0x2f58('0x10')]={'type':String,'required':![],'validate':Validators[_0x2f58('0xf')],'validationError':'The\x20provided\x20Scene\x20thumbnail\x20does\x20not\x20have\x20a\x20valid\x20image\x20file\x20extension.'};_0x410603[_0x2f58('0x4d')]={'type':Number,'required':!![],'default':0xfa0,'validate':_0x4fc186=>Number[_0x2f58('0x37')](_0x4fc186)&&_0x4fc186>0x0,'validationError':'Scene\x20background\x20width\x20must\x20be\x20a\x20positive\x20integer'};_0x410603[_0x2f58('0x55')]={'type':Number,'required':!![],'default':0xbb8,'validate':_0x106a45=>Number[_0x2f58('0x37')](_0x106a45)&&_0x106a45>0x0,'validationError':_0x2f58('0x83')};_0x410603[_0x2f58('0x22')]={'type':Number,'required':!![],'default':0.25,'validate':_0x550737=>Number[_0x2f58('0x69')](_0x550737)&&_0x550737[_0x2f58('0x80')](0x0,0.5),'validation':_0x2f58('0x3b')};_0x410603[_0x2f58('0x0')]={'type':String,'required':!![],'default':_0x2f58('0x7b'),'validate':Validators[_0x2f58('0x5b')],'validationError':_0x2f58('0x53')};_0x410603[_0x2f58('0x4c')]={'type':[Tile],'default':[],'required':!![]};_0x410603[_0x2f58('0x75')]={'type':Number,'required':!![],'default':GRID_TYPES[_0x2f58('0x67')],'validate':_0x300970=>Object['values'](GRID_TYPES)[_0x2f58('0x29')](_0x300970),'validationError':_0x2f58('0x33')};_0x410603[_0x2f58('0x6a')]={'type':Number,'min':0x0,'required':!![],'default':0x64,'validate':_0x4e23c5=>Number[_0x2f58('0x37')](_0x4e23c5)&&_0x4e23c5>=GRID_MIN_SIZE,'validationError':_0x2f58('0x63')+GRID_MIN_SIZE+_0x2f58('0x5f')};_0x410603[_0x2f58('0x12')]={'type':Number,'required':!![],'default':0x0,'validate':_0x44ac6c=>Number[_0x2f58('0x37')](_0x44ac6c),'validationError':'Horizontally\x20shifted\x20scene\x20position\x20must\x20be\x20an\x20integer\x20number\x20of\x20pixels'};_0x410603[_0x2f58('0x23')]={'type':Number,'required':!![],'default':0x0,'validate':_0x4c6320=>Number[_0x2f58('0x37')](_0x4c6320),'validationError':_0x2f58('0x5')};_0x410603[_0x2f58('0x31')]={'type':String,'required':!![],'default':'#000000','validate':Validators['isColorString'],'validationError':_0x2f58('0x32')};_0x410603[_0x2f58('0x3c')]={'type':Number,'required':!![],'default':0.2,'validator':_0x398fb6=>Number[_0x2f58('0x80')](_0x398fb6,0x0,0x1,!![]),'validationError':'Grid\x20opacity\x20must\x20be\x20a\x20number\x20between\x20zero\x20and\x20one.'};_0x410603[_0x2f58('0x7d')]={'type':Number,'required':!![],'min':0x0,'default':()=>game['system']['data']['gridDistance']||0x1,'validate':_0x3e7041=>Number[_0x2f58('0x2c')](_0x3e7041)&&_0x3e7041>0x0,'validationError':_0x2f58('0x76')};_0x410603[_0x2f58('0x44')]={'type':String,'required':![],'default':()=>game[_0x2f58('0x3f')]['data']['gridUnits']};_0x410603[_0x2f58('0x82')]={'type':[Token],'default':[],'required':!![]};_0x410603[_0x2f58('0x6')]={'type':[Wall],'default':[],'required':!![]};_0x410603[_0x2f58('0x74')]={'type':Boolean,'required':!![],'default':!![]};_0x410603[_0x2f58('0x6e')]={'type':Boolean,'required':!![],'default':!![]};_0x410603['fogReset']={'type':Number,'required':![]};_0x410603[_0x2f58('0x61')]={'type':[AmbientLight],'default':[],'required':!![]};_0x410603[_0x2f58('0x5e')]={'type':Boolean,'required':!![],'default':![]};_0x410603[_0x2f58('0x62')]={'type':Number,'required':![],'default':null,'validator':_0x18145=>_0x18145===null||Number['between'](_0x18145,0x0,0x1,!![]),'validationError':_0x2f58('0x26')};_0x410603[_0x2f58('0x43')]={'type':Number,'required':!![],'default':0x0,'validator':_0x127d63=>Number[_0x2f58('0x80')](_0x127d63,0x0,0x1,!![]),'validationError':'Night\x20progression\x20must\x20be\x20between\x200\x20and\x201'};_0x410603['playlist']={'type':Playlist,'required':![]};_0x410603[_0x2f58('0x47')]={'type':[AmbientSound],'default':[],'required':!![]};_0x410603[_0x2f58('0x1b')]={'type':[MeasuredTemplate],'default':[],'required':!![]};_0x410603['journal']={'type':JournalEntry,'required':![]};_0x410603[_0x2f58('0x5a')]={'type':[Note],'default':[],'required':!![]};_0x410603[_0x2f58('0x78')]={'type':String,'required':![]};_0x410603[_0x2f58('0x1a')]={'type':[Drawing],'default':[],'required':!![]};return _0x410603;}static get['metadata'](){return util[_0x2f58('0x27')](super[_0x2f58('0x2f')],{'embeddedEntities':{'AmbientLight':AmbientLight,'AmbientSound':AmbientSound,'Drawing':Drawing,'MeasuredTemplate':MeasuredTemplate,'Note':Note,'Playlist':Playlist,'JournalEntry':JournalEntry,'Tile':Tile,'Token':Token,'Wall':Wall}});}static[_0x2f58('0x1c')](_0x16337c){if(_0x16337c===null)return!![];return typeof _0x16337c==='object'&&Object[_0x2f58('0x49')](_0x16337c)[_0x2f58('0x81')](['x','y','scale'])&&Object[_0x2f58('0x3')](_0x16337c)[_0x2f58('0x34')](_0xb65a0d=>typeof _0xb65a0d===_0x2f58('0x38'));}async[_0x2f58('0xc')](){await Promise[_0x2f58('0x4f')]([db['Combat']['db'][_0x2f58('0x28')]({'scene':this['_id']}),db['FogExploration']['db']['deleteMany']({'scene':this[_0x2f58('0xd')]})]);this[_0x2f58('0x72')]();}async['preSave'](_0x54e7df){await super[_0x2f58('0x41')](_0x54e7df);const _0x57ed52=this[_0x2f58('0x77')]||{};if(_0x57ed52[_0x2f58('0xe')]){await this[_0x2f58('0x73')]();}if(_0x57ed52[_0x2f58('0x4b')]||_0x57ed52[_0x2f58('0x10')]){await this[_0x2f58('0x86')]();}if(_0x57ed52[_0x2f58('0x48')]){this[_0x2f58('0x48')]=Validators[_0x2f58('0x66')](this[_0x2f58('0x48')]);}if(!Number[_0x2f58('0x2c')](this['navOrder']))this['navOrder']=this[_0x2f58('0x3d')];}async[_0x2f58('0x73')](){global['logger'][_0x2f58('0x7a')](_0x2f58('0x88')+this[_0x2f58('0x19')]+'\x20['+this[_0x2f58('0xd')]+']');const _0x4be704=this[_0x2f58('0x7c')]['db'];return new Promise((_0x2d357a,_0x47b4b2)=>{_0x4be704[_0x2f58('0xa')]({'active':!![]},{'$set':{'active':![]}},{'multi':!![]},(_0x56dbe3,_0x3f8c8b,_0x5b2fb2)=>{if(_0x56dbe3)_0x47b4b2(_0x56dbe3);_0x2d357a(_0x5b2fb2);});});}async[_0x2f58('0x86')](){const _0x119234=this['thumb']||'';if(_0x119234==='')this['thumb']=null;this[_0x2f58('0x72')]();if(!this[_0x2f58('0x10')])return;if(_0x119234[_0x2f58('0x16')](_0x2f58('0x65'))){this[_0x2f58('0x84')](_0x119234);}this[_0x2f58('0x18')]=this[_0x2f58('0x10')];}static async[_0x2f58('0x5c')](){const _0x105c30=await this[_0x2f58('0x3a')]({},{});for(let _0x4d7445 of _0x105c30){let _0x103093=![];try{for(let _0x28517b of _0x4d7445[_0x2f58('0x82')]){if(_0x28517b['actorLink']||util[_0x2f58('0x7f')](_0x28517b['actorData'])||!_0x28517b[_0x2f58('0x60')][_0x2f58('0x79')])continue;const _0x3074b2=_0x28517b[_0x2f58('0x60')][_0x2f58('0x79')][_0x2f58('0x45')](_0x5aafca=>new db[(_0x2f58('0x39'))](_0x5aafca));_0x28517b[_0x2f58('0x60')][_0x2f58('0x79')]=_0x3074b2[_0x2f58('0x45')](_0x4b482a=>_0x4b482a['getData']());_0x103093=!![];}await _0x4d7445['save']();}catch(_0x20eb48){global[_0x2f58('0x71')][_0x2f58('0x3e')](_0x20eb48);}}global[_0x2f58('0x71')][_0x2f58('0x7a')]('Successfully\x20migrated\x20'+_0x105c30[_0x2f58('0x4e')]+_0x2f58('0x54'));}get['thumbDir'](){return path[_0x2f58('0x30')](game[_0x2f58('0xb')]['path'],_0x2f58('0x1d'),_0x2f58('0x70'));}[_0x2f58('0x84')](_0x44c49c){let _0x11bfbf=_0x44c49c[_0x2f58('0x6c')](/^data:image\/png;base64,/,''),_0x5550fc=Buffer[_0x2f58('0x57')](_0x11bfbf,_0x2f58('0x2d'));if(!fs[_0x2f58('0x87')](this[_0x2f58('0x4a')]))fs['mkdirSync'](this[_0x2f58('0x4a')]);const _0x4a4f34=this[_0x2f58('0xd')]+'.png';const _0x4be301=path[_0x2f58('0x30')](this[_0x2f58('0x4a')],_0x4a4f34);const _0x1b8c2b=path[_0x2f58('0x4')](global[_0x2f58('0x46')]['data'],_0x4be301);fs[_0x2f58('0x36')](_0x4be301,_0x5550fc);this['thumb']=path[_0x2f58('0x7e')][_0x2f58('0x30')](..._0x1b8c2b[_0x2f58('0x17')](path[_0x2f58('0x1e')]));}[_0x2f58('0x72')](){if(!this['_priorThumbPath'])return;let _0x449dc4=path[_0x2f58('0x30')](global['paths'][_0x2f58('0x6d')],this[_0x2f58('0x18')]);if(!fs['existsSync'](_0x449dc4))return;if(!Files['isPathContained'](_0x449dc4,game[_0x2f58('0xb')][_0x2f58('0x7')])){return global['logger'][_0x2f58('0x3e')]('You\x20may\x20not\x20delete\x20a\x20thumbnail\x20image\x20which\x20is\x20outside\x20of\x20the\x20game\x20world\x20path');}const _0x108e25=mime['lookup'](_0x449dc4);if(!_0x108e25['startsWith'](_0x2f58('0x20'))){return global[_0x2f58('0x71')][_0x2f58('0x3e')](_0x2f58('0x68'));}fs[_0x2f58('0x2b')](_0x449dc4);}static[_0x2f58('0x40')](_0x597aea){return this[_0x2f58('0x1')](_0x597aea);}static[_0x2f58('0x35')](_0x5ccb1){_0x5ccb1['on'](_0x2f58('0x1f'),(_0x4c3feb,_0x532ff4)=>{_0x5ccb1['broadcast'][_0x2f58('0x13')](_0x2f58('0x1f'),_0x4c3feb);_0x532ff4(_0x4c3feb);});_0x5ccb1['on'](_0x2f58('0x15'),(..._0x2aaf2f)=>this['_pullToScene'](_0x5ccb1,..._0x2aaf2f));}static async['_pullToScene'](_0x539fa3,_0x16d7b0,_0x434c3d){if(!_0x539fa3['user'][_0x2f58('0x2e')])return;const _0xa7772e=await db['User']['findOne']({'_id':_0x434c3d});if(!_0xa7772e)return;const _0x3eeabe=_0xa7772e[_0x2f58('0x9')];if(!_0x3eeabe['length'])return;_0x3eeabe[_0x2f58('0x6f')](_0x2b7d21=>_0x539fa3['server']['to'](_0x2b7d21['id'])['emit'](_0x2f58('0x15'),_0x16d7b0));}}const {AmbientLight}=require(_0x2f58('0x58'));const {AmbientSound}=require(_0x2f58('0x56'));const {Drawing}=require('../embedded/drawing');const {MeasuredTemplate}=require(_0x2f58('0x25'));const {Note}=require('../embedded/note');const {Playlist}=require('./playlist');const {JournalEntry}=require(_0x2f58('0x2a'));const {Tile}=require(_0x2f58('0x6b'));const {Token}=require(_0x2f58('0x52'));const {Wall}=require(_0x2f58('0x85'));module[_0x2f58('0x5d')]={'Scene':Scene};